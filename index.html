<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Bimestral</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados para la paleta de colores y la fuente especificada */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ECEFF0; /* Blanco anti-flash */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px; /* Reducido para pantallas pequeñas */
            box-sizing: border-box;
        }
        .container {
            background-color: #FFFFFF; /* Fondo blanco para el formulario */
            border-radius: 1.5rem; /* Esquinas redondeadas */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Sombra sutil */
            padding: 1.5rem; /* Reducido para móviles */
            max-width: 100%; /* Ajustado para abarcar todo el ancho del móvil */
            width: 100%; /* Ajustado para abarcar todo el ancho del móvil */
            transition: all 0.3s ease-in-out;
            /* display: flex; se controla dinámicamente */
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Ajustes responsivos para pantallas más grandes */
        @media (min-width: 640px) { /* Pantallas pequeñas y superiores */
            body {
                padding: 20px; /* Restaurar padding para desktop */
            }
            .container {
                padding: 3rem; /* Restaurar padding para desktop */
                max-width: 90%; /* Restaurar max-width para desktop */
                width: 800px; /* Restaurar width para desktop */
            }
        }

        .gradient-button {
            background-image: linear-gradient(to right, #28418B, #009BCF); /* Azul Marian a Verde Azulado */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* Esquinas redondeadas */
            font-weight: 600;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .gradient-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            opacity: 0.9;
        }
        .gradient-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-image: linear-gradient(to right, #BABBBB, #BABBBB); /* Plateado para deshabilitado */
        }
        .input-field {
            border-radius: 0.5rem;
            border: 1px solid #BABBBB; /* Borde plateado */
            padding: 0.75rem 1rem;
            width: 100%;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #009BCF; /* Verde Azulado al enfocar */
            box-shadow: 0 0 0 3px rgba(0, 155, 207, 0.2); /* Anillo de enfoque suave */
        }
        .label-text {
            font-weight: 600;
            color: #28418B; /* Azul Marian */
            margin-bottom: 0.75rem; /* Increased space below the label */
            display: block;
        }
        .error-message {
            color: #DC2626; /* Rojo para errores */
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .success-message {
            color: #16A34A; /* Verde para éxito */
            font-size: 1rem;
            font-weight: 600;
            margin-top: 1rem;
            text-align: center;
        }
        .summary-box {
            background-color: #FFFFFF; /* Fondo blanco para el resumen */
            border-radius: 1.5rem; /* Esquinas redondeadas */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Sombra sutil */
            padding: 1.5rem; /* Reducido para móviles */
        }
        
        /* Estilos para la página de inicio */
        #intro-page {
            /* display: flex; se controla dinámicamente */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            height: 100vh;
            width: 100%;
            background-color: #ECEFF0;
            padding: 20px;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        #intro-page .logo {
            max-width: 250px;
            height: auto;
            margin-bottom: 2rem;
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        #intro-page h1 {
            color: #28418B;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        #intro-page h2 {
            color: #5B6384;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2.5rem;
        }
        #intro-page .start-button {
            background-image: linear-gradient(to right, #28418B, #009BCF);
            color: white;
            padding: 1rem 2.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }
        #intro-page .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            opacity: 0.95;
        }

        /* Estilos para el botón de la cámara */
        .camera-button, .upload-button {
            background-color: #5B6384;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            margin-top: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            flex-grow: 1; /* Permite que los botones se expandan */
            justify-content: center; /* Centra el contenido del botón */
        }
        .camera-button:hover, .upload-button:hover {
            background-color: #4A516E;
        }
        .file-input-wrapper {
            display: flex;
            flex-direction: column; /* Apila los botones y el nombre del archivo verticalmente */
            gap: 0.5rem; /* Espacio entre los elementos */
            align-items: stretch; /* Estira los elementos para que tengan el mismo ancho */
        }
        .file-input-buttons {
            display: flex;
            gap: 0.5rem; /* Espacio entre los botones */
            width: 100%;
        }
        /* Estilos para prevenir el desbordamiento del nombre del archivo */
        .file-input-wrapper .file-name-span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1; /* Permite que el span ocupe el espacio restante */
            min-width: 0; /* Necesario para que flex-grow funcione correctamente con overflow: hidden */
            display: block; /* Para que ocupe su propia línea */
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #5B6384;
        }

        /* Modal para mensajes de confirmación */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #FFFFFF; /* Fondo blanco */
            margin: auto;
            padding: 30px;
            border: 1px solid #28418B; /* Borde azul del botón */
            width: 80%;
            max-width: 500px;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            transition: all 0.3s ease-in-out;
        }
        .modal-content h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #28418B;
            margin-bottom: 1rem;
        }
        .modal-content p {
            font-size: 1rem;
            color: #5B6384;
            margin-bottom: 1.5rem;
        }
        #modalExistence { /* Estilo para el número de existencia en el modal */ 
            color: #28418B;
            font-size: 3rem;
            font-weight: bold;
            margin-top: 2rem; 
            margin-bottom: 2rem; 
        }
        .modal-footer {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        /* Estilos específicos para el modal de éxito */
        .modal-success {
            background-color: #FFFFFF;
            border-color: #28418B; 
        }
        /* Estilos específicos para el modal de error */
        .modal-error {
            background-color: #FEF2F2;
            border-color: #EF4444; 
        }

        /* Nuevos estilos para la pantalla de resumen mejorada */
        .summary-category-section {
            background-color: #F8FAFC; /* Fondo ligeramente más claro para las secciones */
            border-radius: 0.75rem;
            padding: 1.25rem;
            border: 1px solid #E2E8F0;
            margin-bottom: 1.5rem;
        }
        .summary-category-section:last-child {
            margin-bottom: 0;
        }
        .summary-category-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #28418B;
            text-align: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #D1D5DB;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr; /* Una columna por defecto en móviles */
            gap: 0.75rem;
        }
        @media (min-width: 640px) { /* Dos columnas en pantallas más grandes */
            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Estilo general para items de resumen: ahora siempre en columna */
        .summary-grid-item {
            display: flex;
            flex-direction: column; /* Apila etiqueta y valor verticalmente */
            align-items: center; /* Centra horizontalmente el contenido */
            padding: 0.5rem 0;
        }

        .summary-grid-item .label {
            font-weight: 500;
            color: #5B6384;
            margin-bottom: 0.25rem; /* Pequeño espacio debajo de la etiqueta */
            margin-right: 0; /* Anula el margen derecho en columnas */
            flex-shrink: 0;
            text-align: center; /* Centra el texto de la etiqueta */
            font-size: 0.95rem; /* Ajuste sutil del tamaño de la fuente para mejor legibilidad */
        }
        .summary-grid-item .value {
            color: #28418B;
            flex-grow: 1; 
            word-break: break-word;
            text-align: center; /* Centra el texto del valor */
            font-weight: 600; /* Hace el valor un poco más negrita */
        }

        /* Estilo para el elemento "Nombre de Delegado" para que abarque todo el ancho */
        .summary-delegado-full-width {
            grid-column: 1 / -1; /* Ocupa todas las columnas en la cuadrícula */
        }

        /* Estilo para los totales resaltados dentro de la cuadrícula */
        .summary-grid-item.highlight-total {
            grid-column: 1 / -1; /* Ocupa todo el ancho en la cuadrícula */
            text-align: center;
            background-color: #E0F2F7;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            display: flex;
            flex-direction: column; /* Apila etiqueta y valor para el total */
            align-items: center;
        }
        .summary-grid-item.highlight-total .label {
            font-size: 1.1rem;
            font-weight: 700;
            color: #009BCF;
            margin-bottom: 0.25rem;
            margin-right: 0; /* Anula el margen derecho predeterminado para el apilamiento */
        }
        .summary-grid-item.highlight-total .value {
            font-size: 1.8rem;
            font-weight: 800;
            color: #009BCF;
        }
    </style>
</head>
<body>

    <!-- Página de Inicio -->
    <div id="intro-page" class="w-full">
        <img src="https://github.com/juanbls100/forms_connect_googlesheets/blob/main/Your%20paragraph%20text%20(8).png?raw=true" alt="SIF Logo" class="logo">
        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-blue-900 mb-4">Inventario bimestral de urnas y mamparas</h1>
        <h2 id="introSubtitle" class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-700 mb-8">Sindicato financiero</h2>
        <button id="startButton" class="start-button">Comenzar Captura</button>
    </div>

    <!-- Contenedor del Formulario Principal (inicialmente oculto) -->
    <div id="form-container" class="container hidden">
        <h1 class="text-3xl font-bold text-center text-[#28418B] mb-2 sm:text-4xl">Inventario bimestral de urnas y mamparas</h1>
        <h2 id="dynamicSubtitle" class="text-xl font-bold text-center text-[#5B6384] mb-6 sm:text-2xl">Sindicato financiero</h2>

        <form id="inventoryForm" class="space-y-6">
            <!-- Sección 1 del Formulario (Datos del Trabajador) -->
            <div id="form-section-1">
                <!-- Evento -->
                <div>
                    <label for="evento" class="label-text">Evento</label>
                    <select id="evento" name="Evento" class="input-field" required>
                        <option value="">Selecciona un evento</option>
                        <option value="Legitimación">Legitimación</option>
                        <option value="Revisión">Revisión</option>
                    </select>
                </div>
                <!-- Bimestre -->
                <div>
                    <label for="bimestre" class="label-text">Bimestre</label>
                    <select id="bimestre" name="Bimestre" class="input-field" required>
                        <option value="">Selecciona un bimestre</option>
                        <option value="Ene - Feb">Ene - Feb</option>
                        <option value="Mar - Abr">Mar - Abr</option>
                        <option value="May - Jun">May - Jun</option>
                        <option value="Jul - Ago">Jul - Ago</option>
                        <option value="Sep - Oct">Sep - Oct</option>
                        <option value="Nov - Dic">Nov - Dic</option>
                    </select>
                </div>
                
                <!-- Fecha de inventario -->
                <div>
                    <label for="fechaInventario" class="label-text">Fecha de inventario</label>
                    <input type="date" id="fechaInventario" name="Fecha de inventario" class="input-field" required>
                </div>

                <div>
                    <label for="region" class="label-text">Región</label>
                    <select id="region" name="Región" class="input-field" required>
                        <option value="">Cargando regiones...</option>
                    </select>
                </div>

                <div>
                    <label for="empresa" class="label-text">Empresa</label>
                    <select id="empresa" name="Empresa" class="input-field" required>
                        <option value="">Cargando empresas...</option>
                    </select>
                </div>

                <div>
                    <label for="nombreDelegado" class="label-text">Nombre de Delegado</label>
                    <select id="nombreDelegado" name="Nombre de Delegado" class="input-field" required>
                        <option value="">Cargando delegados...</option>
                    </select>
                </div>
                
                <span id="section1ErrorMessage" class="error-message hidden text-center">Por favor, completa todos los campos de esta sección antes de continuar.</span>
                <div class="flex justify-between mt-6">
                    <button type="button" id="backButtonSection1" class="w-1/2 gradient-button bg-[#5B6384] mr-2">Atrás</button>
                    <button type="button" id="nextButton" class="w-1/2 gradient-button ml-2">Siguiente</button>
                </div>
            </div>

            <!-- Sección para "Legitimación" (anteriormente form-section-2) -->
            <div id="legitimacionSection" class="hidden">
                <!-- Inventario de Urnas -->
                <div>
                    <label for="totalUrnasLegitimacion" class="label-text">Total de urnas (Inventario Inicial)</label>
                    <input type="number" id="totalUrnasLegitimacion" name="Total de urnas" class="input-field" min="0" required disabled>
                    <p id="loadingUrnasLegitimacion" class="text-sm text-gray-500 hidden">Cargando...</p>
                </div>
                
                <div>
                    <label for="traspasosRecibidosLegitimacion" class="label-text">Traspasos recibidos</label>
                    <input type="number" id="traspasosRecibidosLegitimacion" name="Traspasos recibidos" placeholder="Ingrese traspasos recibidos" class="input-field" min="0" required>
                </div>
                <div>
                    <label for="traspasosRealizadosLegitimacion" class="label-text">Traspasos realizados</label>
                    <input type="number" id="traspasosRealizadosLegitimacion" name="Traspasos realizados" placeholder="Ingrese traspasos realizados" class="input-field" min="0" required>
                </div>
                <div>
                    <label for="urnasExtraviadasLegitimacion" class="label-text">Urnas extravíadas</label>
                    <input type="number" id="urnasExtraviadasLegitimacion" name="Urnas extravíadas" placeholder="Ingrese urnas extravíadas" class="input-field" min="0" required>
                </div>
                <div>
                    <label for="urnasRecuperadasLegitimacion" class="label-text">Urnas recuperadas</label>
                    <input type="number" id="urnasRecuperadasLegitimacion" name="Urnas recuperadas" placeholder="Ingrese urnas recuperadas" class="input-field" min="0" required>
                </div>
                <div>
                    <label for="nuevasEntradasLegitimacion" class="label-text">Nuevas entradas</label>
                    <input type="number" id="nuevasEntradasLegitimacion" name="Nuevas entradas" placeholder="Ingrese nuevas entradas" class="input-field" min="0" required>
                </div>

                <div class="mt-8 p-4 bg-[#F8FAFC] rounded-xl border border-[#E2E8F0] shadow-sm">
                    <label class="label-text text-lg block mb-2 text-center">La existencia actual disponible (Urnas):</label>
                    <p id="existenciaActualUrnasLegitimacion" class="text-2xl font-bold text-[#009BCF] text-center">0</p>
                </div>

                <!-- Nuevos campos para reportar el estado de las urnas -->
                <div class="mt-4">
                    <label for="urnasBuenEstadoLegitimacion" class="label-text">Urnas en buen estado</label>
                    <input type="number" id="urnasBuenEstadoLegitimacion" name="Urnas en buen estado" placeholder="Ingrese urnas en buen estado" class="input-field" min="0" required>
                </div>
                <div>
                    <label for="urnasDañadasLegitimacion" class="label-text">Urnas dañadas y/o incompletas</label>
                    <input type="number" id="urnasDañadasLegitimacion" name="Urnas dañadas y/o incompletas" placeholder="Ingrese urnas dañadas" class="input-field" min="0" required>
                </div>

                <!-- Sección de Inventario de Mamparas (oculta por defecto, solo para Bancoppel) -->
                <div id="mamparasSectionLegitimacion" class="hidden mt-8 p-4 bg-[#F8FAFC] rounded-xl border border-[#E2E8F0] shadow-sm">
                    <h3 class="text-xl font-bold text-[#28418B] mb-4 text-center">Inventario de Mamparas</h3>
                    <div>
                        <label for="mamparasInicialLegitimacion" class="label-text">Inventario inicial (Mamparas)</label>
                        <input type="number" id="mamparasInicialLegitimacion" name="Mamparas - Inventario inicial" class="input-field" min="0" disabled>
                        <p id="loadingMamparasLegitimacion" class="text-sm text-gray-500 hidden">Cargando...</p>
                    </div>
                    <div>
                        <label for="mamparasExtraviadasLegitimacion" class="label-text">Extraviadas</label>
                        <input type="number" id="mamparasExtraviadasLegitimacion" name="Mamparas - Extraviadas" placeholder="Ingrese mamparas extraviadas" class="input-field" min="0">
                    </div>
                    <div>
                        <label for="mamparasDañadasLegitimacion" class="label-text">Dañadas e incompletas</label>
                        <input type="number" id="mamparasDañadasLegitimacion" name="Mamparas - Dañadas e incompletas" placeholder="Ingrese mamparas dañadas e incompletas" class="input-field" min="0">
                    </div>
                    <div class="mt-4 p-4 bg-white rounded-xl border border-[#E2E8F0] shadow-sm">
                        <label class="label-text text-lg block mb-2 text-center">Total disponible (Mamparas):</label>
                        <p id="totalDisponibleMamparasLegitimacion" class="text-2xl font-bold text-[#009BCF] text-center">0</p>
                    </div>
                </div>

                <!-- Campo de Observaciones para Legitimación -->
                <div class="mt-8">
                    <label for="observacionesLegitimacion" class="label-text">Observaciones (Legitimación)</label>
                    <textarea id="observacionesLegitimacion" name="Observaciones (Legitimación)" class="input-field" rows="3" placeholder="Ingrese cualquier observación adicional para la legitimación"></textarea>
                </div>
                
                <div class="flex justify-between mt-6">
                    <button type="button" id="backButtonLegitimacion" class="w-1/2 gradient-button bg-[#5B6384] mr-2">Atrás</button>
                    <button type="button" id="nextButtonLegitimacion" class="w-1/2 gradient-button ml-2">Siguiente</button>
                </div>
            </div>

            <!-- Nueva Sección para "Revisión" -->
            <div id="revisionSection" class="hidden">
                <!-- Inventario de Urnas (para Revisión) -->
                <div>
                    <label for="totalUrnasRevision" class="label-text">Total de urnas (Inventario Inicial)</label>
                    <input type="number" id="totalUrnasRevision" name="Total de urnas" class="input-field" min="0" required disabled>
                    <p id="loadingUrnasRevision" class="text-sm text-gray-500 hidden">Cargando...</p>
                </div>
                <div>
                    <label for="traspasosRecibidosRevision" class="label-text">Traspasos recibidos</label>
                    <input type="number" id="traspasosRecibidosRevision" name="Traspasos recibidos" placeholder="Ingrese traspasos recibidos" class="input-field" min="0" required>
                </div>
                <div>
                    <label for="traspasosRealizadosRevision" class="label-text">Traspasos realizados</label>
                    <input type="number" id="traspasosRealizadosRevision" name="Traspasos realizados" placeholder="Ingrese traspasos realizados" class="input-field" min="0" required>
                </div>
                <div>
                    <label for="urnasExtraviadasRevision" class="label-text">Urnas extravíadas</label>
                    <input type="number" id="urnasExtraviadasRevision" name="Urnas extravíadas" placeholder="Ingrese urnas extravíadas" class="input-field" min="0" required>
                </div>
                <div>
                    <label for="urnasRecuperadasRevision" class="label-text">Urnas recuperadas</label>
                    <input type="number" id="urnasRecuperadasRevision" name="Urnas recuperadas" placeholder="Ingrese urnas recuperadas" class="input-field" min="0" required>
                </div>
                <div>
                    <label for="nuevasEntradasRevision" class="label-text">Nuevas entradas</label>
                    <input type="number" id="nuevasEntradasRevision" name="Nuevas entradas" placeholder="Ingrese nuevas entradas" class="input-field" min="0" required>
                </div>

                <div class="mt-8 p-4 bg-[#F8FAFC] rounded-xl border border-[#E2E8F0] shadow-sm">
                    <label class="label-text text-lg block mb-2 text-center">La existencia actual disponible (Urnas):</label>
                    <p id="existenciaActualUrnasRevision" class="text-2xl font-bold text-[#009BCF] text-center">0</p>
                </div>

                <!-- Nuevos campos para reportar el estado de las urnas en Revisión -->
                <div class="mt-4">
                    <label for="urnasBuenEstadoRevision" class="label-text">Urnas en buen estado</label>
                    <input type="number" id="urnasBuenEstadoRevision" name="Urnas en buen estado" placeholder="Ingrese urnas en buen estado" class="input-field" min="0" required>
                </div>
                <div>
                    <label for="urnasDañadasRevision" class="label-text">Urnas dañadas y/o incompletas</label>
                    <input type="number" id="urnasDañadasRevision" name="Urnas dañadas y/o incompletas" placeholder="Ingrese urnas dañadas" class="input-field" min="0" required>
                </div>

                <!-- Campo de Observaciones para Revisión -->
                <div class="mt-8">
                    <label for="observacionesRevision" class="label-text">Observaciones (Revisión)</label>
                    <textarea id="observacionesRevision" name="Observaciones (Revisión)" class="input-field" rows="3" placeholder="Ingrese cualquier observación adicional para la revisión"></textarea>
                </div>

                <div class="flex justify-between mt-6">
                    <button type="button" id="backButtonRevision" class="w-1/2 gradient-button bg-[#5B6384] mr-2">Atrás</button>
                    <button type="button" id="nextButtonRevision" class="w-1/2 gradient-button ml-2">Tomar evidencia fotográfica</button>
                </div>
            </div>

            <!-- Sección de Toma de Evidencia Fotográfica (Nueva) -->
            <div id="photoEvidenceSection" class="hidden">
                <h3 class="text-xl font-bold text-[#28418B] mb-4 text-center">Fotos Cargadas</h3>
                
                <!-- Photos for Revisión (conditionally shown via JS) -->
                <div id="revisionPhotosDiv" class="hidden">
                    <div>
                        <label class="label-text">Portada de urnas</label>
                        <div class="file-input-wrapper">
                            <!-- Input para la cámara -->
                            <input type="file" id="portadaUrnasCameraInputRevision" accept="image/*" capture="environment" class="hidden">
                            <!-- Input para subir archivo -->
                            <input type="file" id="portadaUrnasFileInputRevision" accept="image/*" class="hidden">
                            <div class="file-input-buttons">
                                <button type="button" id="openPortadaUrnasCameraRevision" class="camera-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera">
                                        <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                                        <circle cx="12" cy="13" r="3"/>
                                    </svg>
                                    Abrir cámara
                                </button>
                                <button type="button" id="openPortadaUrnasFileRevision" class="upload-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" x2="12" y1="3" y2="15"/>
                                    </svg>
                                    Seleccionar archivo
                                </button>
                            </div>
                            <span id="portadaUrnasFileNameRevisionSpan" class="text-sm text-gray-600 file-name-span">No se ha seleccionado archivo.</span>
                        </div>
                    </div>

                    <div>
                        <label class="label-text">Foto de Urnas</label>
                        <div class="file-input-wrapper">
                            <!-- Input para la cámara -->
                            <input type="file" id="fotoUrnasCameraInputRevision" accept="image/*" capture="environment" class="hidden">
                            <!-- Input para subir archivo -->
                            <input type="file" id="fotoUrnasFileInputRevision" accept="image/*" class="hidden">
                            <div class="file-input-buttons">
                                <button type="button" id="openFotoUrnasCameraRevision" class="camera-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera">
                                        <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                                        <circle cx="12" cy="13" r="3"/>
                                    </svg>
                                    Abrir cámara
                                </button>
                                <button type="button" id="openFotoUrnasFileRevision" class="upload-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" x2="12" y1="3" y2="15"/>
                                    </svg>
                                    Seleccionar archivo
                                </button>
                            </div>
                            <span id="fotoUrnasFileNameRevisionSpan" class="text-sm text-gray-600 file-name-span">No se ha seleccionado archivo.</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between mt-6">
                    <button type="button" id="backButtonPhotoEvidence" class="w-1/2 gradient-button bg-[#5B6384] mr-2">Atrás</button>
                    <button type="button" id="nextButtonPhotoEvidence" class="w-1/2 gradient-button ml-2">Siguiente</button>
                </div>
            </div>

            <div id="urlError" class="error-message hidden text-center">
                Error: La URL de Google Apps Script no ha sido configurada. Por favor, reemplaza 'PEGA_TU_URL_DE_APLICACION_WEB_AQUI' en el código JavaScript.
            </div>
            
            <div id="responseMessage" class="hidden"></div>
        </form>

        <!-- Sección de Resumen y Guardado Final (inicialmente oculta) -->
        <div id="summarySection" class="summary-box hidden">
            <h3 class="text-xl font-bold text-[#28418B] text-center mb-4">Resumen de Datos Capturados</h3>
            <div id="summaryContent">
                </div>
            <div class="flex justify-between mt-6">
                <button type="button" id="modifyDataButton" class="w-1/2 gradient-button bg-[#5B6384] mr-2">Modificar Datos</button>
                <button type="button" id="saveDataButton" class="w-1/2 gradient-button ml-2">Guardar datos</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div id="confirmationModal" class="modal">
        <div id="modalContent" class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div id="modalExistence" class="text-5xl font-bold hidden" style="color: #28418B; margin-top: 2rem; margin-bottom: 2rem;"></div>
            <div class="modal-footer">
                <button id="modalOkButton" class="gradient-button">Aceptar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // IMPORTANT: Replace with the actual URL of your Google Apps Script
            const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzbXUemrBUEYtZS_zPyOlap8-SmHWKXFCz4bgVjGqy9m3VwcNKymFbNcbl4mUpRYMlZJQ/exec'; 

            const introPage = document.getElementById('intro-page');
            const introSubtitle = document.getElementById('introSubtitle'); 
            const startButton = document.getElementById('startButton');
            const formContainer = document.getElementById('form-container');
            const dynamicSubtitle = document.getElementById('dynamicSubtitle');
            const inventoryForm = document.getElementById('inventoryForm');
            const urlError = document.getElementById('urlError');
            const responseMessage = document.getElementById('responseMessage');
            const summarySection = document.getElementById('summarySection');
            const summaryContent = document.getElementById('summaryContent');
            const saveDataButton = document.getElementById('saveDataButton'); 
            const modifyDataButton = document.getElementById('modifyDataButton'); 

            // Elements for multi-section form
            const formSection1 = document.getElementById('form-section-1');
            const nextButtonSection1 = document.getElementById('nextButton'); 
            const backButtonSection1 = document.getElementById('backButtonSection1'); 
            
            // Legitimación Section elements
            const legitimacionSection = document.getElementById('legitimacionSection');
            const totalUrnasLegitimacionInput = document.getElementById('totalUrnasLegitimacion'); 
            const loadingUrnasLegitimacion = document.getElementById('loadingUrnasLegitimacion');
            const existenciaActualUrnasLegitimacionDisplay = document.getElementById('existenciaActualUrnasLegitimacion'); 
            const urnasBuenEstadoLegitimacionInput = document.getElementById('urnasBuenEstadoLegitimacion'); // NEW
            const urnasDañadasLegitimacionInput = document.getElementById('urnasDañadasLegitimacion'); // Re-purposed
            const mamparasSectionLegitimacion = document.getElementById('mamparasSectionLegitimacion');
            const mamparasInicialLegitimacionInput = document.getElementById('mamparasInicialLegitimacion');
            const loadingMamparasLegitimacion = document.getElementById('loadingMamparasLegitimacion');
            const mamparasExtraviadasLegitimacionInput = document.getElementById('mamparasExtraviadasLegitimacion');
            const mamparasDañadasLegitimacionInput = document.getElementById('mamparasDañadasLegitimacion');
            const totalDisponibleMamparasLegitimacionDisplay = document.getElementById('totalDisponibleMamparasLegitimacion');
            const backButtonLegitimacion = document.getElementById('backButtonLegitimacion');
            const nextButtonLegitimacion = document.getElementById('nextButtonLegitimacion');

            // Revision Section elements
            const revisionSection = document.getElementById('revisionSection');
            const totalUrnasRevisionInput = document.getElementById('totalUrnasRevision'); 
            const loadingUrnasRevision = document.getElementById('loadingUrnasRevision');
            const existenciaActualUrnasRevisionDisplay = document.getElementById('existenciaActualUrnasRevision'); 
            const urnasBuenEstadoRevisionInput = document.getElementById('urnasBuenEstadoRevision'); // NEW
            const urnasDañadasRevisionInput = document.getElementById('urnasDañadasRevision'); // Re-purposed
            const backButtonRevision = document.getElementById('backButtonRevision');
            const nextButtonRevision = document.getElementById('nextButtonRevision');

            // Photo Evidence Section elements
            const photoEvidenceSection = document.getElementById('photoEvidenceSection');
            const revisionPhotosDiv = document.getElementById('revisionPhotosDiv');

            // Portada Urnas (Camera & File)
            const portadaUrnasCameraInputRevision = document.getElementById('portadaUrnasCameraInputRevision');
            const openPortadaUrnasCameraRevisionButton = document.getElementById('openPortadaUrnasCameraRevision');
            const portadaUrnasFileInputRevision = document.getElementById('portadaUrnasFileInputRevision'); // New file input
            const openPortadaUrnasFileRevisionButton = document.getElementById('openPortadaUrnasFileRevision'); // New file button
            const portadaUrnasFileNameRevisionSpan = document.getElementById('portadaUrnasFileNameRevisionSpan'); 

            // Foto Urnas (Camera & File)
            const fotoUrnasCameraInputRevision = document.getElementById('fotoUrnasCameraInputRevision');
            const openFotoUrnasCameraRevisionButton = document.getElementById('openFotoUrnasCameraRevision');
            const fotoUrnasFileInputRevision = document.getElementById('fotoUrnasFileInputRevision'); // New file input
            const openFotoUrnasFileRevisionButton = document.getElementById('openFotoUrnasFileRevision'); // New file button
            const fotoUrnasFileNameRevisionSpan = document.getElementById('fotoUrnasFileNameRevisionSpan'); 

            // Modal elements
            const confirmationModal = document.getElementById('confirmationModal');
            const modalContent = document.getElementById('modalContent'); 
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalExistence = document.getElementById('modalExistence'); 
            const modalOkButton = document.getElementById('modalOkButton');

            // General Selects
            const eventoSelect = document.getElementById('evento');
            const empresaSelect = document.getElementById('empresa'); 
            const regionSelect = document.getElementById('region'); 
            const nombreDelegadoSelect = document.getElementById('nombreDelegado');


            // Global variables to store all form data before final submission, including Base64 image data
            let allFormData = {};
            let portadaUrnasRevisionBase64 = ''; 
            let fotoUrnasRevisionBase64 = '';    

            let currentActiveEventType = ''; // To track if 'Legitimación' or 'Revisión' is active


            /**
             * Reads a file as a Base64 string.
             * @param {File} file - The file to read.
             * @param {function(string): void} callback - The callback function to receive the Base64 string.
             */
            function readFileAsBase64(file, callback) {
                if (!file) {
                    callback('');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    callback(event.target.result); // result will be a data URL (Base64)
                };
                reader.onerror = function(event) {
                    console.error("Error reading file:", event.target.error);
                    callback(''); // Return empty string on error
                };
                reader.readAsDataURL(file);
            }

            /**
             * Displays a confirmation modal with a title, message, and type.
             * @param {string} title - The title of the modal.
             * @param {string} message - The message to display in the modal.
             * @param {string} type - 'success', 'error', or any other (default 'info').
             */
            function showModal(title, message, type = 'info') { 
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalExistence.textContent = ''; 
                modalExistence.classList.add('hidden'); 

                modalContent.classList.remove('modal-success', 'modal-error');
                modalContent.style.borderColor = '#28418B'; 

                if (type === 'success') {
                    modalContent.classList.add('modal-success');
                } else if (type === 'error') {
                    modalContent.classList.add('modal-error');
                }

                confirmationModal.style.display = 'flex'; 
            }

            // Close modal when "Accept" button is clicked
            modalOkButton.addEventListener('click', () => {
                confirmationModal.style.display = 'none';
            });

            /**
             * Controls visibility of different form sections.
             * @param {string} sectionId - The ID of the section to show ('intro', 'section1', 'legitimacion', 'revision', 'photoEvidence', 'summary').
             */
            function showSection(sectionId) {
                // Hide all potential main sections by adding 'hidden' class
                introPage.classList.add('hidden');
                formContainer.classList.add('hidden'); // The main form container
                formSection1.classList.add('hidden');
                legitimacionSection.classList.add('hidden');
                revisionSection.classList.add('hidden');
                photoEvidenceSection.classList.add('hidden'); // New photo section
                summarySection.classList.add('hidden');

                // Set display style for intro page directly as it's position fixed
                introPage.style.display = 'none';
                formContainer.style.display = 'none';

                // Now, show the specific section requested and its parent container if needed
                if (sectionId === 'intro') {
                    introPage.classList.remove('hidden'); 
                    introPage.style.display = 'flex'; // Ensure it's flex for centering
                } else if (sectionId === 'section1') {
                    formContainer.classList.remove('hidden');
                    formContainer.style.display = 'flex'; // Ensure form container is flex
                    formSection1.classList.remove('hidden');
                } else if (sectionId === 'legitimacion') {
                    formContainer.classList.remove('hidden');
                    formContainer.style.display = 'flex';
                    legitimacionSection.classList.remove('hidden');
                } else if (sectionId === 'revision') {
                    formContainer.classList.remove('hidden');
                    formContainer.style.display = 'flex';
                    revisionSection.classList.remove('hidden');
                } else if (sectionId === 'photoEvidence') { // NEW
                    formContainer.classList.remove('hidden');
                    formContainer.style.display = 'flex';
                    photoEvidenceSection.classList.remove('hidden');

                    // Always hide Legitimación photo div (ADD NULL CHECK HERE)
                    // Note: 'legitimacionPhotosDiv' was removed from HTML as per previous instructions, 
                    // so this null check prevents error if it's referenced.
                    const legitimacionPhotosDiv = document.getElementById('legitimacionPhotosDiv');
                    if (legitimacionPhotosDiv) { 
                        legitimacionPhotosDiv.classList.add('hidden');
                    }
                    
                    // Only show Revision photo div if current event is Revision
                    if (currentActiveEventType === 'Revisión') {
                        revisionPhotosDiv.classList.remove('hidden');
                    } else {
                        // If it's Legitimación and somehow landed here, hide revision photos too
                        revisionPhotosDiv.classList.add('hidden');
                    }

                } else if (sectionId === 'summary') {
                    formContainer.classList.remove('hidden');
                    formContainer.style.display = 'flex';
                    summarySection.classList.remove('hidden');
                }

                // Update subtitle based on section
                if (sectionId === 'intro') {
                    dynamicSubtitle.textContent = 'Sindicato financiero'; // This subtitle is not visible on intro page, but good for consistency
                    dynamicSubtitle.classList.add('mb-6');
                    dynamicSubtitle.classList.remove('mb-2');
                } else if (sectionId === 'section1') {
                    dynamicSubtitle.textContent = 'Sindicato financiero - Datos Generales';
                    dynamicSubtitle.classList.remove('mb-2');
                    dynamicSubtitle.classList.add('mb-6');
                } else if (sectionId === 'legitimacion') {
                    dynamicSubtitle.textContent = 'Confirmación de Datos de Urnas y Mamparas (Legitimación)';
                    dynamicSubtitle.classList.remove('mb-6');
                    dynamicSubtitle.classList.add('mb-2');
                } else if (sectionId === 'revision') {
                    dynamicSubtitle.textContent = 'Confirmación de Datos de Urnas (Revisión)';
                    dynamicSubtitle.classList.remove('mb-6');
                    dynamicSubtitle.classList.add('mb-2');
                } else if (sectionId === 'photoEvidence') { // NEW
                    dynamicSubtitle.textContent = 'Captura de Evidencia Fotográfica';
                    dynamicSubtitle.classList.remove('mb-6');
                    dynamicSubtitle.classList.add('mb-2');
                } else if (sectionId === 'summary') {
                    dynamicSubtitle.textContent = 'Resumen para Guardar';
                    dynamicSubtitle.classList.remove('mb-6');
                    dynamicSubtitle.classList.add('mb-2');
                }
            }


            /**
             * Checks if the Google Apps Script URL is configured correctly
             * and enables/disables the submit button as needed.
             */
            function checkUrlAndButton() {
                if (!GOOGLE_APPS_SCRIPT_URL.startsWith('http')) {
                    saveDataButton.disabled = true; 
                    urlError.classList.remove('hidden');
                    console.error("Error: Google Apps Script URL has not been configured or is invalid. Please ensure it starts with 'http'.");
                } else {
                    saveDataButton.disabled = false; 
                    urlError.classList.add('hidden');
                }
            }

            /**
             * Calculates and updates the "Current available existence" value for urns.
             * Handles both Legitimación and Revisión sections.
             */
            function calculateExistenciaActualUrnas(eventType) {
                let totalUrnasInputEl, traspasosRecibidosEl, traspasosRealizadosEl, urnasExtraviadasEl, urnasRecuperadasEl, nuevasEntradasEl, existenciaDisplayEl;

                if (eventType === 'Legitimación') {
                    totalUrnasInputEl = document.getElementById('totalUrnasLegitimacion');
                    traspasosRecibidosEl = document.getElementById('traspasosRecibidosLegitimacion');
                    traspasosRealizadosEl = document.getElementById('traspasosRealizadosLegitimacion');
                    urnasExtraviadasEl = document.getElementById('urnasExtraviadasLegitimacion');
                    urnasRecuperadasEl = document.getElementById('urnasRecuperadasLegitimacion');
                    nuevasEntradasEl = document.getElementById('nuevasEntradasLegitimacion');
                    existenciaDisplayEl = document.getElementById('existenciaActualUrnasLegitimacion');
                } else if (eventType === 'Revisión') {
                    totalUrnasInputEl = document.getElementById('totalUrnasRevision');
                    traspasosRecibidosEl = document.getElementById('traspasosRecibidosRevision');
                    traspasosRealizadosEl = document.getElementById('traspasosRealizadosRevision');
                    urnasExtraviadasEl = document.getElementById('urnasExtraviadasRevision');
                    urnasRecuperadasEl = document.getElementById('urnasRecuperadasRevision');
                    nuevasEntradasEl = document.getElementById('nuevasEntradasRevision');
                    existenciaDisplayEl = document.getElementById('existenciaActualUrnasRevision');
                } else {
                    return; // Invalid eventType
                }
                
                const totalUrnas = parseInt(totalUrnasInputEl.value) || 0; 
                const traspasosRecibidos = parseInt(traspasosRecibidosEl.value) || 0;
                const traspasosRealizados = parseInt(traspasosRealizadosEl.value) || 0;
                const urnasExtraviadas = parseInt(urnasExtraviadasEl.value) || 0;
                const urnasRecuperadas = parseInt(urnasRecuperadasEl.value) || 0;
                const nuevasEntradas = parseInt(nuevasEntradasEl.value) || 0;

                // CAMBIO AQUÍ: La existencia ya no resta las urnas dañadas
                const existencia = totalUrnas + traspasosRecibidos - traspasosRealizados - urnasExtraviadas + urnasRecuperadas + nuevasEntradas;
                existenciaDisplayEl.textContent = existencia;
            }

            /**
             * Calculates and updates the "Total available" value for partitions (Legitimación only).
             */
            function calculateTotalDisponibleMamparas() {
                const mamparasInicial = parseInt(mamparasInicialLegitimacionInput.value) || 0;
                const mamparasExtraviadas = parseInt(mamparasExtraviadasLegitimacionInput.value) || 0;
                const mamparasDañadas = parseInt(mamparasDañadasLegitimacionInput.value) || 0;

                const totalDisponible = mamparasInicial - mamparasExtraviadas - mamparasDañadas;
                totalDisponibleMamparasLegitimacionDisplay.textContent = totalDisponible;
            }

            // Add event listeners for Legitimación urn fields
            // Asegurarse de que los nuevos campos de estado también disparen el cálculo principal
            document.querySelectorAll('#legitimacionSection input[type="number"]').forEach(input => {
                // Solo los campos que afectan el cálculo de existencia principal
                if (input.id !== 'urnasBuenEstadoLegitimacion' && input.id !== 'urnasDañadasLegitimacion') {
                    input.addEventListener('input', () => calculateExistenciaActualUrnas('Legitimación'));
                }
            });
            // Add event listeners for Legitimación mamparas fields
            mamparasInicialLegitimacionInput.addEventListener('input', calculateTotalDisponibleMamparas);
            mamparasExtraviadasLegitimacionInput.addEventListener('input', calculateTotalDisponibleMamparas);
            mamparasDañadasLegitimacionInput.addEventListener('input', calculateTotalDisponibleMamparas);

            // Add event listeners for Revision urn fields
            // Asegurarse de que los nuevos campos de estado también disparen el cálculo principal
            document.querySelectorAll('#revisionSection input[type="number"]').forEach(input => {
                 if (input.id !== 'urnasBuenEstadoRevision' && input.id !== 'urnasDañadasRevision') {
                    input.addEventListener('input', () => calculateExistenciaActualUrnas('Revisión'));
                }
            });

            /**
             * Fetches initial inventory data based on selected company and region.
             * Now also considers the active event type.
             */
            async function fetchInitialInventory(eventoType) { // Modified function signature to accept eventoType
                const empresa = empresaSelect.value;
                const region = regionSelect.value;

                // Clear previous values and show loading for both potential sections
                loadingUrnasLegitimacion.classList.remove('hidden');
                totalUrnasLegitimacionInput.value = ''; 
                loadingMamparasLegitimacion.classList.remove('hidden');
                mamparasInicialLegitimacionInput.value = ''; 
                loadingUrnasRevision.classList.remove('hidden');
                totalUrnasRevisionInput.value = ''; 

                if (empresa && region && eventoType) { // Added eventoType check
                    try {
                        const fetchUrl = `${GOOGLE_APPS_SCRIPT_URL}?type=inventory&empresa=${encodeURIComponent(empresa)}&region=${encodeURIComponent(region)}&evento=${encodeURIComponent(eventoType)}`; // Added eventoType to URL
                        const response = await fetch(fetchUrl);
                        const result = await response.json();

                        if (result.status === 'success' && result.data) {
                            // Apply to both potential sections, but only the active one will be visible
                            totalUrnasLegitimacionInput.value = result.data.inventarioInicialUrnas;
                            totalUrnasRevisionInput.value = result.data.inventarioInicialUrnas; // Same initial urns for both events
                            mamparasInicialLegitimacionInput.value = result.data.inventarioInicialMamparas;
                        } else {
                            console.error('Error fetching initial inventory:', result.message);
                            showModal('Error de Carga', 'No se pudieron cargar los datos de inventario inicial para la empresa/región seleccionada. Se establecerán en 0.', 'error');
                            totalUrnasLegitimacionInput.value = 0;
                            totalUrnasRevisionInput.value = 0;
                            mamparasInicialLegitimacionInput.value = 0;
                        }
                    } catch (error) {
                        console.error('Network error fetching initial inventory:', error);
                        showModal('Error de Red', 'No se pudo conectar para cargar los datos de inventario inicial. Asegúrate de tener conexión a internet. Se establecerán en 0.', 'error');
                        totalUrnasLegitimacionInput.value = 0;
                        totalUrnasRevisionInput.value = 0;
                        mamparasInicialLegitimacionInput.value = 0;
                    } finally {
                        loadingUrnasLegitimacion.classList.add('hidden');
                        loadingMamparasLegitimacion.classList.add('hidden');
                        loadingUrnasRevision.classList.add('hidden');
                        calculateExistenciaActualUrnas('Legitimación'); 
                        calculateExistenciaActualUrnas('Revisión'); 
                        calculateTotalDisponibleMamparas(); 
                    }
                } else {
                    totalUrnasLegitimacionInput.value = 0;
                    totalUrnasRevisionInput.value = 0;
                    mamparasInicialLegitimacionInput.value = 0;
                    calculateExistenciaActualUrnas('Legitimación');
                    calculateExistenciaActualUrnas('Revisión');
                    calculateTotalDisponibleMamparas();
                }
            }

            /**
             * Fetches unique dropdown options from Apps Script.
             */
            async function fetchDropdownOptions(fieldName, selectElement, loadingMessage, filterParams = {}) {
                selectElement.innerHTML = `<option value="">${loadingMessage}</option>`;
                selectElement.disabled = true;

                let fetchUrl = `${GOOGLE_APPS_SCRIPT_URL}?type=dropdown&field=${encodeURIComponent(fieldName)}`;
                for (const key in filterParams) {
                    if (filterParams.hasOwnProperty(key)) {
                        fetchUrl += `&${encodeURIComponent(key)}=${encodeURIComponent(filterParams[key])}`;
                    }
                }

                try {
                    const response = await fetch(fetchUrl);
                    const result = await response.json();

                    if (result.status === 'success' && Array.isArray(result.data)) {
                        selectElement.innerHTML = `<option value="">Selecciona ${fieldName.toLowerCase().replace(' de ', ' del ').replace(' del delegado', ' el delegado')}</option>`;
                        result.data.forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option;
                            opt.textContent = option;
                            selectElement.appendChild(opt);
                        });
                    } else {
                        console.error(`Error fetching ${fieldName} options:`, result.message);
                        selectElement.innerHTML = `<option value="">Error al cargar ${fieldName.toLowerCase().replace(' de ', ' del ').replace(' del delegado', ' el delegado')}</option>`;
                        showModal('Error de Carga', `No se pudieron cargar las opciones para ${fieldName}.`, 'error');
                    }
                } catch (error) {
                    console.error(`Network error fetching ${fieldName} options:`, error);
                    selectElement.innerHTML = `<option value="">Error de red al cargar ${fieldName.toLowerCase().replace(' de ', ' del ').replace(' del delegado', ' el delegado')}</option>`;
                    showModal('Error de Red', `No se pudo conectar para cargar las opciones de ${fieldName}. Asegúrate de tener conexión a internet.`, 'error');
                } finally {
                    selectElement.disabled = false;
                }
            }

            // Event listener for region change to filter delegate names
            regionSelect.addEventListener('change', () => {
                const selectedRegion = regionSelect.value;
                if (selectedRegion) {
                    // Pass the selected region as a filter parameter
                    fetchDropdownOptions('Nombre de Delegado', nombreDelegadoSelect, 'Cargando delegados...', { region: selectedRegion });
                } else {
                    nombreDelegadoSelect.innerHTML = '<option value="">Selecciona una región primero</option>';
                    nombreDelegadoSelect.disabled = true;
                }
                fetchInitialInventory(eventoSelect.value); // Pass event type
            });

            // Event listener for empresa change to toggle mamparas section visibility (only for Legitimación)
            empresaSelect.addEventListener('change', () => {
                if (eventoSelect.value === 'Legitimación') {
                    if (empresaSelect.value === 'Bancoppel') {
                        mamparasSectionLegitimacion.classList.remove('hidden');
                        mamparasInicialLegitimacionInput.setAttribute('required', 'true');
                        mamparasExtraviadasLegitimacionInput.setAttribute('required', 'true');
                        mamparasDañadasLegitimacionInput.setAttribute('required', 'true');
                    } else {
                        mamparasSectionLegitimacion.classList.add('hidden');
                        mamparasInicialLegitimacionInput.removeAttribute('required');
                        mamparasExtraviadasLegitimacionInput.removeAttribute('required');
                        mamparasDañadasLegitimacionInput.removeAttribute('required');
                        // Clear mamparas values if section is hidden
                        mamparasInicialLegitimacionInput.value = '';
                        mamparasExtraviadasLegitimacionInput.value = '';
                        mamparasDañadasLegitimacionInput.value = '';
                        totalDisponibleMamparasLegitimacionDisplay.textContent = '0';
                    }
                }
                fetchInitialInventory(eventoSelect.value); // Pass event type
            });

            // Event listener for "Evento" dropdown change
            eventoSelect.addEventListener('change', () => {
                const selectedEvent = eventoSelect.value;
                // Reset visibility of mamparas section based on event selection
                if (selectedEvent === 'Legitimación' && empresaSelect.value === 'Bancoppel') {
                    mamparasSectionLegitimacion.classList.remove('hidden');
                    mamparasInicialLegitimacionInput.setAttribute('required', 'true');
                    mamparasExtraviadasLegitimacionInput.setAttribute('required', 'true');
                    mamparasDañadasLegitimacionInput.setAttribute('required', 'true');
                } else {
                    mamparasSectionLegitimacion.classList.add('hidden');
                    mamparasInicialLegitimacionInput.removeAttribute('required');
                    mamparasExtraviadasLegitimacionInput.removeAttribute('required');
                    mamparasDañadasLegitimacionInput.removeAttribute('required');
                    // Clear mamparas values if section is hidden
                    mamparasInicialLegitimacionInput.value = '';
                    mamparasExtraviadasLegitimacionInput.value = '';
                    mamparasDañadasLegitimacionInput.value = '';
                    totalDisponibleMamparasLegitimacionDisplay.textContent = '0';
                }
                // Important: Also re-fetch inventory when event type changes, as the initial inventory source depends on it.
                // But only if Empresa and Region are already selected.
                if (empresaSelect.value && regionSelect.value) {
                    fetchInitialInventory(selectedEvent);
                }
            });


            // Event listener for "Start Capture" button (from intro page)
            startButton.addEventListener('click', () => {
                showSection('section1');
                checkUrlAndButton(); 
                // Fetch initial dropdown options when starting (only regions and companies)
                fetchDropdownOptions('Región', regionSelect, 'Cargando regiones...');
                fetchDropdownOptions('Empresa', empresaSelect, 'Cargando empresas...');
                
                // Nombre de Delegado will be loaded when region is selected
                nombreDelegadoSelect.innerHTML = '<option value="">Selecciona una región primero</option>';
                nombreDelegadoSelect.disabled = true;
                // Clear inputs for all sections
                inventoryForm.reset();
                existenciaActualUrnasLegitimacionDisplay.textContent = '0';
                totalDisponibleMamparasLegitimacionDisplay.textContent = '0'; 
                existenciaActualUrnasRevisionDisplay.textContent = '0';
                
                // Clear photo-related spans and Base64 data only for Revision, as Legitimación photos are removed
                portadaUrnasFileNameRevisionSpan.textContent = 'No se ha seleccionado archivo.';
                fotoUrnasFileNameRevisionSpan.textContent = 'No se ha seleccionado archivo.';
                portadaUrnasRevisionBase64 = ''; 
                fotoUrnasRevisionBase64 = '';    
                
                mamparasSectionLegitimacion.classList.add('hidden'); // Hide mamparas section initially
            });

            // Event listener for "Back" button in section 1 of the form
            backButtonSection1.addEventListener('click', () => {
                showSection('intro');
            });

            // Event listener for "Next" button (in section 1)
            nextButtonSection1.addEventListener('click', () => {
                const selectedEvent = eventoSelect.value;
                const fechaInventario = document.getElementById('fechaInventario');
                const region = document.getElementById('region');
                const empresa = document.getElementById('empresa');
                const nombreDelegado = document.getElementById('nombreDelegado');
                const bimestre = document.getElementById('bimestre'); 

                if (!selectedEvent || !bimestre.value || !fechaInventario.value || !region.value || !empresa.value || !nombreDelegado.value.trim()) {
                    section1ErrorMessage.classList.remove('hidden');
                    return;
                } else {
                    section1ErrorMessage.classList.add('hidden');
                }
                
                currentActiveEventType = selectedEvent; 

                if (selectedEvent === 'Legitimación') {
                    showSection('legitimacion');
                } else if (selectedEvent === 'Revisión') {
                    showSection('revision');
                }
                fetchInitialInventory(selectedEvent); // Pass selectedEvent here
            });

            // Event listener for "Back" button in Legitimación section
            backButtonLegitimacion.addEventListener('click', () => {
                showSection('section1');
            });

            // Event listener for "Next" button in Legitimación section (now directly to Summary)
            nextButtonLegitimacion.addEventListener('click', () => {
                // No se valida urnasDañadasLegitimacion como parte del cálculo, sino como un reporte
                const traspasosRecibidos = document.getElementById('traspasosRecibidosLegitimacion');
                const traspasosRealizados = document.getElementById('traspasosRealizadosLegitimacion');
                const urnasExtraviadas = document.getElementById('urnasExtraviadasLegitimacion');
                const urnasRecuperadas = document.getElementById('urnasRecuperadasLegitimacion');
                const nuevasEntradas = document.getElementById('nuevasEntradasLegitimacion');
                const urnasBuenEstado = document.getElementById('urnasBuenEstadoLegitimacion'); // NEW
                const urnasDañadas = document.getElementById('urnasDañadasLegitimacion'); // Re-purposed
                const observacionesLegitimacion = document.getElementById('observacionesLegitimacion');


                // Basic validation for numeric urn fields (editable ones)
                if (traspasosRecibidos.value === '' ||
                    traspasosRealizados.value === '' || urnasExtraviadas.value === '' || 
                    urnasRecuperadas.value === '' || nuevasEntradas.value === '' ||
                    urnasBuenEstado.value === '' || urnasDañadas.value === '') { // Include new fields
                    showModal('Campos Incompletos', 'Por favor, completa todos los campos numéricos de urnas antes de continuar.', 'error');
                    return;
                }

                // Validation for partition fields if the section is visible
                const isMamparasSectionVisible = !mamparasSectionLegitimacion.classList.contains('hidden');
                if (isMamparasSectionVisible) {
                    const mamparasExtraviadas = document.getElementById('mamparasExtraviadasLegitimacion');
                    const mamparasDañadas = document.getElementById('mamparasDañadasLegitimacion');

                    if (mamparasExtraviadas.value === '' || mamparasDañadas.value === '') {
                        showModal('Campos Incompletos', 'Por favor, completa todos los campos numéricos de mamparas antes de continuar.', 'error');
                        return;
                    }
                }

                // Collect all form data from Legitimación section and form-section-1
                allFormData = {}; // Reset allFormData
                const formElements = inventoryForm.elements;
                for (let i = 0; i < formElements.length; i++) {
                    const element = formElements[i];
                    if (element.name && element.type !== 'button' && 
                        (formSection1.contains(element) || legitimacionSection.contains(element))) {
                        
                        // Exclude mamparas fields if section is not visible
                        if (!isMamparasSectionVisible && element.closest('#mamparasSectionLegitimacion')) {
                            continue; 
                        }
                        allFormData[element.name] = element.value;
                    }
                }
                allFormData['Total disponible (Urnas)'] = existenciaActualUrnasLegitimacionDisplay.textContent; 
                if (isMamparasSectionVisible) {
                    allFormData['Total disponible (Mamparas)'] = totalDisponibleMamparasLegitimacionDisplay.textContent; 
                }
                allFormData['Observaciones (Legitimación)'] = observacionesLegitimacion.value; // Add observations
                // No photo data is added for Legitimación

                displaySummary(allFormData, isMamparasSectionVisible, currentActiveEventType);
                showSection('summary'); // Directly go to summary
            });

            // Event listener for "Back" button in Revision section
            backButtonRevision.addEventListener('click', () => {
                showSection('section1');
            });

            // Event listener for "Next" button in Revision section (still to Photo Evidence Section)
            nextButtonRevision.addEventListener('click', () => {
                // No se valida urnasDañadasRevision como parte del cálculo, sino como un reporte
                const traspasosRecibidos = document.getElementById('traspasosRecibidosRevision');
                const traspasosRealizados = document.getElementById('traspasosRealizadosRevision');
                const urnasExtraviadas = document.getElementById('urnasExtraviadasRevision');
                const urnasRecuperadas = document.getElementById('urnasRecuperadasRevision');
                const nuevasEntradas = document.getElementById('nuevasEntradasRevision');
                const urnasBuenEstado = document.getElementById('urnasBuenEstadoRevision'); // NEW
                const urnasDañadas = document.getElementById('urnasDañadasRevision'); // Re-purposed
                const observacionesRevision = document.getElementById('observacionesRevision');


                // Basic validation for numeric urn fields (editable ones)
                if (traspasosRecibidos.value === '' ||
                    traspasosRealizados.value === '' || urnasExtraviadas.value === '' || 
                    urnasRecuperadas.value === '' || nuevasEntradas.value === '' ||
                    urnasBuenEstado.value === '' || urnasDañadas.value === '') { // Include new fields
                    showModal('Campos Incompletos', 'Por favor, completa todos los campos numéricos de urnas antes de continuar.', 'error');
                    return;
                }

                // Collect all form data from Revision section and form-section-1
                allFormData = {}; // Reset allFormData
                const formElements = inventoryForm.elements;
                for (let i = 0; i < formElements.length; i++) {
                    const element = formElements[i];
                    if (element.name && element.type !== 'button' && 
                        (formSection1.contains(element) || revisionSection.contains(element))) {
                        allFormData[element.name] = element.value;
                    }
                }
                allFormData['Total disponible (Urnas)'] = existenciaActualUrnasRevisionDisplay.textContent; 
                allFormData['Observaciones (Revisión)'] = observacionesRevision.value; // Add observations


                showSection('photoEvidence'); // Go to photo evidence section
            });

            // Event listener for "Back" button in Photo Evidence section
            backButtonPhotoEvidence.addEventListener('click', () => {
                // Only go back to revision section from photo evidence
                showSection('revision');
            });

            // Event listener for "Next" button in Photo Evidence section (to Summary)
            nextButtonPhotoEvidence.addEventListener('click', () => {
                let photosAreValid = true;

                // Only validate and process photos if the current event type is Revision
                if (currentActiveEventType === 'Revisión') {
                    if (!portadaUrnasRevisionBase64 || !fotoUrnasRevisionBase64) {
                        photosAreValid = false;
                        showModal('Fotos Incompletas', 'Por favor, carga la Portada y la Foto de Urnas para Revisión.', 'error');
                    } else {
                        allFormData['Portada de urnas (Archivo)'] = portadaUrnasRevisionBase64;
                        allFormData['Foto de Urnas (Archivo)'] = fotoUrnasRevisionBase64;
                    }
                } 
                // For Legitimación, photos are not required, so no validation here

                if (photosAreValid) {
                    const isMamparasVisible = (currentActiveEventType === 'Legitimación' && empresaSelect.value === 'Bancoppel');
                    displaySummary(allFormData, isMamparasVisible, currentActiveEventType); 
                    showSection('summary');
                }
            });

            // Event listeners to open camera via custom button for Revisión Photos
            openPortadaUrnasCameraRevisionButton.addEventListener('click', () => {
                portadaUrnasCameraInputRevision.click(); 
            });
            openFotoUrnasCameraRevisionButton.addEventListener('click', () => {
                fotoUrnasCameraInputRevision.click(); 
            });

            // Event listeners to open file input via custom button for Revisión Photos
            openPortadaUrnasFileRevisionButton.addEventListener('click', () => {
                portadaUrnasFileInputRevision.click(); 
            });
            openFotoUrnasFileRevisionButton.addEventListener('click', () => {
                fotoUrnasFileInputRevision.click(); 
            });

            // Event listeners to update file name display and read file as Base64 for Revisión Photos
            // Handlers for Camera Input
            portadaUrnasCameraInputRevision.addEventListener('change', (event) => {
                if (event.target.files.length > 0) {
                    const file = event.target.files[0];
                    portadaUrnasFileNameRevisionSpan.textContent = file.name;
                    readFileAsBase64(file, (base64) => {
                        portadaUrnasRevisionBase64 = base64;
                    });
                } else {
                    portadaUrnasFileNameRevisionSpan.textContent = 'No se ha seleccionado archivo.';
                    portadaUrnasRevisionBase64 = '';
                }
            });
            fotoUrnasCameraInputRevision.addEventListener('change', (event) => {
                if (event.target.files.length > 0) {
                    const file = event.target.files[0];
                    fotoUrnasFileNameRevisionSpan.textContent = file.name;
                    readFileAsBase64(file, (base64) => {
                        fotoUrnasRevisionBase64 = base64;
                    });
                } else {
                    fotoUrnasFileNameRevisionSpan.textContent = 'No se ha seleccionado archivo.';
                    fotoUrnasRevisionBase64 = '';
                }
            });

            // Handlers for File Input
            portadaUrnasFileInputRevision.addEventListener('change', (event) => {
                if (event.target.files.length > 0) {
                    const file = event.target.files[0];
                    portadaUrnasFileNameRevisionSpan.textContent = file.name;
                    readFileAsBase64(file, (base64) => {
                        portadaUrnasRevisionBase64 = base64;
                    });
                } else {
                    portadaUrnasFileNameRevisionSpan.textContent = 'No se ha seleccionado archivo.';
                    portadaUrnasRevisionBase64 = '';
                }
            });
            fotoUrnasFileInputRevision.addEventListener('change', (event) => {
                if (event.target.files.length > 0) {
                    const file = event.target.files[0];
                    fotoUrnasFileNameRevisionSpan.textContent = file.name;
                    readFileAsBase64(file, (base64) => {
                        fotoUrnasRevisionBase64 = base64;
                    });
                } else {
                    fotoUrnasFileNameRevisionSpan.textContent = 'No se ha seleccionado archivo.';
                    fotoUrnasRevisionBase64 = '';
                }
            });


            // Event listener for "Save Data" button (on the summary page)
            saveDataButton.addEventListener('click', async () => {
                // Disable the button and show loading message immediately
                saveDataButton.disabled = true;
                responseMessage.classList.remove('hidden');
                responseMessage.classList.remove('success-message', 'error-message');
                responseMessage.textContent = 'Enviando datos...';
                responseMessage.style.color = '#5B6384'; 

                if (!GOOGLE_APPS_SCRIPT_URL.startsWith('http')) {
                    console.error("Google Apps Script URL not configured or invalid.");
                    showModal('Error de Configuración', 'La URL de Google Apps Script no ha sido configurada correctamente. Contacta al administrador.', 'error');
                    // Re-enable the button on error
                    saveDataButton.disabled = false;
                    responseMessage.classList.add('hidden'); // Hide loading message
                    return;
                }

                try {
                    const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Essential for Google Apps Script Web App POST requests
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(allFormData), 
                    });

                    // Clear loading message and show success modal
                    responseMessage.textContent = ''; 
                    showModal('¡Datos Registrados con Éxito!', 'La información ha sido guardada correctamente.', 'success');

                    // Reset form after successful submission
                    inventoryForm.reset();
                    existenciaActualUrnasLegitimacionDisplay.textContent = '0';
                    totalDisponibleMamparasLegitimacionDisplay.textContent = '0'; 
                    existenciaActualUrnasRevisionDisplay.textContent = '0';
                    
                    // Clear photo-related spans and Base64 data only for Revision
                    portadaUrnasFileNameRevisionSpan.textContent = 'No se ha seleccionado archivo.';
                    fotoUrnasFileNameRevisionSpan.textContent = 'No se ha seleccionado archivo.';
                    portadaUrnasRevisionBase64 = ''; 
                    fotoUrnasRevisionBase64 = '';    
                    
                    mamparasSectionLegitimacion.classList.add('hidden'); 
                    currentActiveEventType = ''; // Reset event type

                    showSection('intro'); // Go back to intro page

                    // Re-fetch dropdown options to reset them
                    fetchDropdownOptions('Región', regionSelect, 'Cargando regiones...');
                    fetchDropdownOptions('Empresa', empresaSelect, 'Cargando empresas...');
                    // Reset delegate dropdown as well
                    nombreDelegadoSelect.innerHTML = '<option value="">Selecciona una región primero</option>';
                    nombreDelegadoSelect.disabled = true;

                } catch (error) {
                    console.error('Error al enviar los datos:', error);
                    responseMessage.textContent = ''; 
                    showModal('Error al Registrar Datos', 'Hubo un problema al intentar guardar la información. Por favor, inténtalo de nuevo.', 'error');
                } finally {
                    // Always re-enable the button and hide loading message
                    saveDataButton.disabled = false;
                    responseMessage.classList.add('hidden');
                }
            });

            /**
             * Displays a summary of captured data.
             * @param {object} data - The captured data to display in the summary.
             * @param {boolean} showMamparas - Whether the mamparas section was visible in the form.
             * @param {string} eventType - The type of event ('Legitimación' or 'Revisión').
             */
            function displaySummary(data, showMamparas, eventType) {
                summaryContent.innerHTML = ''; // Clear previous content

                // Helper function to create a grid item
                const createGridItem = (label, value, isDelegado = false) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('summary-grid-item');
                    if (isDelegado) {
                        itemDiv.classList.add('summary-delegado-full-width');
                    }
                    const labelSpan = document.createElement('span');
                    labelSpan.classList.add('label');
                    labelSpan.textContent = label + ':';
                    const valueSpan = document.createElement('span');
                    valueSpan.classList.add('value');
                    // Handle file names vs. "Foto cargada"
                    // MODIFICACIÓN CLAVE AQUÍ: Verificar la etiqueta del campo de forma explícita
                    if (label === 'Portada de urnas' || label === 'Foto de Urnas') {
                        valueSpan.textContent = value ? 'Foto cargada' : 'No se ha seleccionado imagen.';
                        valueSpan.style.whiteSpace = 'nowrap'; 
                        valueSpan.style.overflow = 'hidden';
                        valueSpan.style.textOverflow = 'ellipsis';
                    } else {
                        valueSpan.textContent = value;
                    }
                    itemDiv.appendChild(labelSpan);
                    itemDiv.appendChild(valueSpan);
                    return itemDiv;
                };

                // Helper function to create a highlighted total item
                const createTotalItem = (label, value) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('summary-grid-item', 'highlight-total');
                    const labelSpan = document.createElement('span');
                    labelSpan.classList.add('label');
                    labelSpan.textContent = label; // No colon here as it's a title
                    const valueSpan = document.createElement('span');
                    valueSpan.classList.add('value');
                    valueSpan.textContent = value;
                    itemDiv.appendChild(labelSpan);
                    itemDiv.appendChild(valueSpan);
                    return itemDiv;
                };

                // --- Sección: Datos del Trabajador ---
                const workerSection = document.createElement('div');
                workerSection.classList.add('summary-category-section');
                workerSection.innerHTML = '<h4 class="summary-category-title">Datos del Trabajador</h4><div class="summary-grid"></div>';
                const workerGrid = workerSection.querySelector('.summary-grid');
                workerGrid.appendChild(createGridItem('Evento', data['Evento']));
                workerGrid.appendChild(createGridItem('Bimestre', data['Bimestre']));
                workerGrid.appendChild(createGridItem('Fecha de inventario', data['Fecha de inventario']));
                workerGrid.appendChild(createGridItem('Región', data['Región']));
                workerGrid.appendChild(createGridItem('Empresa', data['Empresa']));
                workerGrid.appendChild(createGridItem('Nombre de Delegado', data['Nombre de Delegado'], true)); 
                summaryContent.appendChild(workerSection);

                // --- Sección: Inventario de Urnas ---
                const urnsSection = document.createElement('div');
                urnsSection.classList.add('summary-category-section');
                urnsSection.innerHTML = '<h4 class="summary-category-title">Inventario de Urnas</h4><div class="summary-grid"></div>';
                const urnsGrid = urnsSection.querySelector('.summary-grid');
                urnsGrid.appendChild(createGridItem('Total de urnas (Inicial)', data['Total de urnas']));
                // El campo "Urnas dañadas y/o incompletas" ya no se resta aquí, solo se reporta al final.
                urnsGrid.appendChild(createGridItem('Traspasos recibidos', data['Traspasos recibidos']));
                urnsGrid.appendChild(createGridItem('Traspasos realizados', data['Traspasos realizados']));
                urnsGrid.appendChild(createGridItem('Urnas extravíadas', data['Urnas extravíadas']));
                urnsGrid.appendChild(createGridItem('Urnas recuperadas', data['Urnas recuperadas']));
                urnsGrid.appendChild(createGridItem('Nuevas entradas', data['Nuevas entradas']));
                // Add the highlighted total for urns (this is now the calculated physical total)
                urnsGrid.appendChild(createTotalItem('Existencia Actual Urnas', data['Total disponible (Urnas)']));
                
                // Nuevos campos de reporte para Urnas en buen estado y Urnas dañadas
                urnsGrid.appendChild(createGridItem('Urnas en buen estado', data['Urnas en buen estado']));
                urnsGrid.appendChild(createGridItem('Urnas dañadas y/o incompletas', data['Urnas dañadas y/o incompletas']));

                summaryContent.appendChild(urnsSection);

                // --- Sección: Inventario de Mamparas (condicional para Legitimación) ---
                if (eventType === 'Legitimación' && showMamparas) {
                    const mamparasSummarySection = document.createElement('div');
                    mamparasSummarySection.classList.add('summary-category-section');
                    mamparasSummarySection.innerHTML = '<h4 class="summary-category-title">Inventario de Mamparas</h4><div class="summary-grid"></div>';
                    const mamparasGrid = mamparasSummarySection.querySelector('.summary-grid');
                    mamparasGrid.appendChild(createGridItem('Inventario inicial (Mamparas)', data['Mamparas - Inventario inicial']));
                    mamparasGrid.appendChild(createGridItem('Mamparas extravíadas', data['Mamparas - Extraviadas']));
                    mamparasGrid.appendChild(createGridItem('Mamparas dañadas', data['Mamparas - Dañadas e incompletas']));
                    // Add the highlighted total for mamparas
                    mamparasGrid.appendChild(createTotalItem('Total Disponible Mamparas', data['Total disponible (Mamparas)']));
                    summaryContent.appendChild(mamparasSummarySection);
                }

                // --- Nueva Sección: Observaciones (Legitimación) ---
                // Solo muestra si el evento es Legitimación y hay datos en el campo de observaciones
                if (eventType === 'Legitimación' && data['Observaciones (Legitimación)']) { 
                    const observacionesLegitimacionSection = document.createElement('div');
                    observacionesLegitimacionSection.classList.add('summary-category-section');
                    observacionesLegitimacionSection.innerHTML = '<h4 class="summary-category-title">Observaciones (Legitimación)</h4><div class="summary-grid"></div>';
                    const obsLegGrid = observacionesLegitimacionSection.querySelector('.summary-grid');
                    obsLegGrid.appendChild(createGridItem('Observaciones', data['Observaciones (Legitimación)'], true)); // Make it full width
                    summaryContent.appendChild(observacionesLegitimacionSection);
                }

                // --- Nueva Sección: Fotos Cargadas (Solo si es Revisión) ---
                if (eventType === 'Revisión') {
                    const fileUploadsSection = document.createElement('div');
                    fileUploadsSection.classList.add('summary-category-section');
                    fileUploadsSection.innerHTML = '<h4 class="summary-category-title">Fotos Cargadas</h4><div class="summary-grid"></div>'; 
                    const fileUploadsGrid = fileUploadsSection.querySelector('.summary-grid');

                    // Only display Revision photo labels/placeholders
                    fileUploadsGrid.appendChild(createGridItem('Portada de urnas', data['Portada de urnas (Archivo)']));
                    fileUploadsGrid.appendChild(createGridItem('Foto de Urnas', data['Foto de Urnas (Archivo)']));
                    
                    summaryContent.appendChild(fileUploadsSection);

                    // --- Nueva Sección: Observaciones (Revisión) ---
                    // Solo muestra si el evento es Revisión y hay datos en el campo de observaciones
                    if (data['Observaciones (Revisión)']) { 
                        const observacionesRevisionSection = document.createElement('div');
                        observacionesRevisionSection.classList.add('summary-category-section');
                        observacionesRevisionSection.innerHTML = '<h4 class="summary-category-title">Observaciones (Revisión)</h4><div class="summary-grid"></div>';
                        const obsRevGrid = observacionesRevisionSection.querySelector('.summary-grid');
                        obsRevGrid.appendChild(createGridItem('Observaciones', data['Observaciones (Revisión)'], true)); // Make it full width
                        summaryContent.appendChild(observacionesRevisionSection);
                    }
                }
            }

            // Event listener for "Modify Data" button (on the summary section)
            modifyDataButton.addEventListener('click', () => {
                // If it was a Revision event, go back to photo evidence.
                // If it was Legitimación, go back to the legitimación data section.
                if (currentActiveEventType === 'Revisión') {
                    showSection('photoEvidence'); 
                } else if (currentActiveEventType === 'Legitimación') {
                    showSection('legitimacion'); 
                    // Re-apply mamparas section visibility if needed (for Legitimación)
                    if (empresaSelect.value === 'Bancoppel') {
                        mamparasSectionLegitimacion.classList.remove('hidden');
                        mamparasInicialLegitimacionInput.setAttribute('required', 'true');
                        mamparasExtraviadasLegitimacionInput.setAttribute('required', 'true');
                        mamparasDañadasLegitimacionInput.setAttribute('required', 'true');
                    }
                }
                responseMessage.classList.add('hidden'); 
            });

            // Initial check when the script loads
            checkUrlAndButton();
            showSection('intro'); // Start on the intro page
        }); // End DOMContentLoaded
    </script>
</body>
</html>
